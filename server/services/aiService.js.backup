/**
 * AI Service for Resume Analysis
 * This service provides intelligent analysis of resumes against job descriptions.
 * Currently uses a mock implementation with realistic analysis.
 * Can be extended to integrate with OpenAI, Gemini, or other AI APIs.
 */

import { GoogleGenerativeAI } from '@google/generative-ai';

/**
 * AI-Powered Career Path Prediction using Gemini API
// Validate and sanitize the response
return {
    bestFitRoles: (careerPath.bestFitRoles || []).slice(0, 4),
    futureRoles: (careerPath.futureRoles || []).slice(0, 3),
    missingCertifications: (careerPath.missingCertifications || []).slice(0, 4),
    skillsRoadmap: (careerPath.skillsRoadmap || []).slice(0, 5)
};
    } catch (error) {
    console.error('Gemini API Error:', error.message);
    throw error; // Let the controller handle fallback
}
}


/**
 * Analyzes a resume against a job description
 * @param {string} resumeText - The resume content
 * @param {string} jobDescription - The job description to compare against
 * @returns {Promise<Object>} Analysis results
 */
// export async function analyzeResume(resumeText, jobDescription) {
//     // Mock AI analysis - provides realistic structured feedback
//     // In production, replace this with actual AI API calls (OpenAI, Gemini, etc.)

//     await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate API delay

//     // Extract key information for realistic analysis
//     const resumeLower = resumeText.toLowerCase();
//     const jdLower = jobDescription.toLowerCase();

//     // Common skills to check
//     const commonSkills = ['javascript', 'python', 'java', 'react', 'node', 'sql', 'mongodb',
//         'aws', 'docker', 'kubernetes', 'git', 'agile', 'typescript', 'vue',
//         'angular', 'express', 'rest api', 'graphql', 'ci/cd', 'testing'];

//     // Find skills in resume and JD
//     const resumeSkills = commonSkills.filter(skill => resumeLower.includes(skill));
//     const jdSkills = commonSkills.filter(skill => jdLower.includes(skill));
//     const missingSkills = jdSkills.filter(skill => !resumeSkills.includes(skill));

//     // Calculate ATS score based on multiple factors for more realistic scoring
//     const matchingSkills = jdSkills.filter(skill => resumeSkills.includes(skill));

//     // Factor 1: Skill matching (40% weight)
//     let skillScore = 0;
//     if (jdSkills.length > 0) {
//         skillScore = (matchingSkills.length / jdSkills.length) * 40;
//     } else {
//         // If no predefined skills found in JD, use keyword overlap
//         const resumeWords = new Set(resumeLower.split(/\s+/).filter(w => w.length > 3));
//         const jdWords = new Set(jdLower.split(/\s+/).filter(w => w.length > 3));
//         const commonWords = [...resumeWords].filter(w => jdWords.has(w));
//         skillScore = Math.min((commonWords.length / Math.max(jdWords.size, 1)) * 40, 40);
//     }

//     // Factor 2: Resume completeness (25% weight)
//     let completenessScore = 0;
//     if (resumeText.length > 500) completenessScore += 8;
//     if (resumeText.length > 1000) completenessScore += 7;
//     if (resumeLower.includes('education') || resumeLower.includes('degree')) completenessScore += 5;
//     if (resumeLower.includes('experience') || resumeLower.includes('work')) completenessScore += 5;

//     // Factor 3: Experience level (20% weight)
//     let experienceScore = 0;
//     if (resumeLower.includes('senior') || resumeLower.includes('lead')) experienceScore += 10;
//     else if (resumeLower.includes('mid-level') || resumeLower.includes('intermediate')) experienceScore += 7;
//     else experienceScore += 4;

//     if (resumeLower.match(/\d+\+?\s*years?/)) experienceScore += 5;
//     if (resumeLower.includes('project') || resumeLower.includes('developed')) experienceScore += 5;

//     // Factor 4: Keywords and metrics (15% weight)
//     let keywordScore = 0;
//     if (resumeLower.includes('achieve') || resumeLower.includes('improve')) keywordScore += 5;
//     if (resumeLower.match(/\d+%/)) keywordScore += 5; // Has percentages (metrics)
//     if (resumeLower.includes('team') || resumeLower.includes('collaborate')) keywordScore += 5;

//     // Calculate final score
//     const totalScore = skillScore + completenessScore + experienceScore + keywordScore;

//     // Add some variance (-5 to +5) and cap between 0-100
//     const variance = (Math.random() - 0.5) * 10;
//     const atsScore = Math.max(45, Math.min(95, Math.round(totalScore + variance)));

//     // Generate dynamic strengths
//     const strengths = [];
//     if (resumeSkills.length > 5) {
//         strengths.push(`Strong technical skill set with ${resumeSkills.length} relevant technologies`);
//     }
//     if (resumeText.length > 500) {
//         strengths.push('Comprehensive professional experience documented');
//     }
//     if (resumeLower.includes('lead') || resumeLower.includes('senior')) {
//         strengths.push('Demonstrated leadership and advanced role experience');
//     }
//     if (matchingSkills.length > 0) {
//         strengths.push(`${matchingSkills.length} key skills align with job requirements`);
//     }
//     if (resumeLower.includes('project') || resumeLower.includes('built') || resumeLower.includes('developed')) {
//         strengths.push('Clear demonstration of hands-on project experience');
//     }

//     // Generate dynamic weaknesses
//     const weaknesses = [];
//     if (missingSkills.length > 0) {
//         weaknesses.push(`Missing ${missingSkills.length} skills mentioned in job description`);
//     }
//     if (!resumeLower.includes('education') && !resumeLower.includes('degree')) {
//         weaknesses.push('Educational background not clearly highlighted');
//     }
//     if (!resumeLower.includes('certificate') && !resumeLower.includes('certification')) {
//         weaknesses.push('No professional certifications mentioned');
//     }
//     if (resumeText.length < 300) {
//         weaknesses.push('Resume appears brief - consider adding more detail about achievements');
//     }

//     // Generate suggestions
//     const suggestions = [];
//     if (missingSkills.length > 0) {
//         suggestions.push(`Consider gaining experience in: ${missingSkills.slice(0, 3).join(', ')}`);
//     }
//     suggestions.push('Use quantifiable achievements (e.g., "Improved performance by 40%")');
//     suggestions.push('Tailor resume to match job description keywords more closely');
//     if (!resumeLower.includes('github') && !resumeLower.includes('portfolio')) {
//         suggestions.push('Include links to GitHub profile or portfolio to showcase projects');
//     }
//     suggestions.push('Ensure consistent formatting and clear section headers');
//     if (atsScore < 75) {
//         suggestions.push('Optimize resume with more keywords from the job description');
//     }

//     // Generate summary
//     const summary = `This resume demonstrates ${atsScore > 70 ? 'strong' : 'moderate'} alignment with the job requirements. ` +
//         `The candidate shows proficiency in ${resumeSkills.slice(0, 3).join(', ')} and related technologies. ` +
//         `${missingSkills.length > 0 ? `However, experience in ${missingSkills.slice(0, 2).join(' and ')} should be developed to better match the role.` : 'The skill set closely matches the job requirements.'} ` +
//         `With targeted improvements, this resume could achieve a higher ATS score.`;

//     return {
//         summary,
//         strengths: strengths.length > 0 ? strengths : ['Relevant professional experience'],
//         weaknesses: weaknesses.length > 0 ? weaknesses : ['Consider highlighting specific achievements'],
//         missingSkills,
//         atsScore,
//         suggestions
//     };
// }
export async function analyzeResume(resumeText, jobDescription) {
    // Mock AI analysis - strictly deterministic
    await new Promise(resolve => setTimeout(resolve, 1000));

    const resumeLower = resumeText.toLowerCase();
    const jdLower = jobDescription.toLowerCase();

    // 1. EXPANDED SKILL LIBRARY & CATEGORIES
    // Real ATS systems differentiate between hard skills (tech) and soft skills.
    const techSkills = [
        'javascript', 'python', 'java', 'c++', 'c#', 'react', 'node.js', 'node',
        'sql', 'nosql', 'mongodb', 'postgresql', 'aws', 'azure', 'gcp',
        'docker', 'kubernetes', 'git', 'ci/cd', 'jenkins', 'terraform',
        'typescript', 'vue', 'angular', 'express', 'rest api', 'graphql',
        'machine learning', 'data analysis', 'linux', 'bash', 'html', 'css'
    ];

    const softSkills = [
        'leadership', 'communication', 'agile', 'scrum', 'problem solving',
        'collaboration', 'teamwork', 'mentoring', 'analytical', 'strategic'
    ];

    // Helper: Use Regex for exact word boundaries (prevents "Java" matching "Javascript")
    const hasWord = (text, word) => {
        // Escape special regex characters (like C++)
        const escaped = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`\\b${escaped}\\b`, 'i');
        return regex.test(text);
    };

    // 2. DYNAMIC JD PARSING (What does the JD actually want?)
    // We extract skills specifically requested in the JD
    const requiredTechSkills = techSkills.filter(skill => hasWord(jdLower, skill));
    const requiredSoftSkills = softSkills.filter(skill => hasWord(jdLower, skill));

    // 3. RESUME SCANNING
    const matchedTechSkills = requiredTechSkills.filter(skill => hasWord(resumeLower, skill));
    const matchedSoftSkills = requiredSoftSkills.filter(skill => hasWord(resumeLower, skill));
    const missingSkills = requiredTechSkills.filter(skill => !matchedTechSkills.includes(skill));

    // 4. STRICT SCORING ALGORITHM
    let score = 0;
    const debugLog = []; // Useful for understanding the score

    // A. Keyword Match Score (Max 45 points)
    // Tech skills are weighted double compared to soft skills
    const totalRequiredWeight = (requiredTechSkills.length * 2) + requiredSoftSkills.length;
    const actualWeight = (matchedTechSkills.length * 2) + matchedSoftSkills.length;

    if (totalRequiredWeight > 0) {
        const matchPercentage = actualWeight / totalRequiredWeight;
        score += matchPercentage * 45;
    } else {
        // Fallback if JD describes no known skills (unlikely but possible)
        score += 20;
    }

    // B. Content Structure & Sections (Max 20 points)
    // Real ATS parses by section headers. If they are missing, parsing fails.
    const sections = {
        experience: /work\s*experience|employment\s*history|professional\s*experience/i.test(resumeText),
        education: /education|university|college|degree|academic/i.test(resumeText),
        skills: /skills|technologies|competencies|stack/i.test(resumeText),
        projects: /projects|portfolio/i.test(resumeText)
    };

    if (sections.experience) score += 8;
    if (sections.education) score += 5;
    if (sections.skills) score += 4;
    if (sections.projects) score += 3;

    // C. Impact & Metrics Check (Max 20 points)
    // ATS algorithms look for numbers (%, $, 10x) indicating results.
    // We use regex to find patterns like "20%", "$50k", "5+ years"
    const metricsMatches = resumeText.match(/(\d+%|\$\d+|\d+\+)/g) || [];
    // Cap at 4 metrics (5 points each)
    score += Math.min(metricsMatches.length, 4) * 5;

    // D. Formatting & Action Verbs (Max 15 points)
    // Check for strong action verbs (indicates good writing)
    const actionVerbs = ['managed', 'developed', 'engineered', 'architected', 'deployed', 'spearheaded', 'optimized', 'orchestrated'];
    const verbCount = actionVerbs.filter(v => hasWord(resumeLower, v)).length;
    score += Math.min(verbCount, 3) * 3; // Max 9 points

    // Check for Contact Info (Strict requirement)
    const hasEmail = /[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}/.test(resumeText);
    const hasPhone = /(\+\d{1,3}[-.]?)?\(?\d{3}\)?[-.]?\d{3}[-.]?\d{4}/.test(resumeText);
    if (hasEmail) score += 3;
    if (hasPhone) score += 3;

    // 5. GENERATE FEEDBACK
    const strengths = [];
    const weaknesses = [];
    const suggestions = [];

    // Round score and ensure strict bounds
    const atsScore = Math.max(10, Math.min(98, Math.round(score)));

    // Construct Strengths
    if (matchedTechSkills.length === requiredTechSkills.length && requiredTechSkills.length > 0) {
        strengths.push("Perfect match for technical skill requirements");
    } else if (matchedTechSkills.length > 0) {
        strengths.push(`Matches ${matchedTechSkills.length} critical technical skills found in JD`);
    }
    if (metricsMatches.length > 2) strengths.push("Strong use of quantifiable metrics (%, $)");
    if (sections.experience && sections.education) strengths.push("Good structural formatting (Standard headers found)");

    // Construct Weaknesses
    if (missingSkills.length > 0) {
        // Highlighting specific missing hard skills is the most valuable ATS insight
        weaknesses.push(`Critical Skills Missing: ${missingSkills.slice(0, 5).join(', ')}`);
    }
    if (!sections.experience) weaknesses.push("ATS could not parse a 'Work Experience' section");
    if (metricsMatches.length === 0) weaknesses.push("Lacks quantifiable achievements (numbers/metrics)");
    if (verbCount === 0) weaknesses.push("Language is passive; lacks strong action verbs");

    // Construct Suggestions
    // 1. Fix Missing Skills
    if (missingSkills.length > 0) {
        suggestions.push(`Integrate these keywords into your skills or experience: ${missingSkills.slice(0, 3).join(', ')}.`);
    }

    // 2. Fix Formatting/Sections (Directly addressing the error you saw)
    if (!sections.experience) {
        suggestions.push("Rename your experience header to 'Work Experience' or 'Professional Experience' so the ATS can find it.");
    }
    if (!sections.education) {
        suggestions.push("Add a clear 'Education' section header.");
    }
    if (!sections.skills) {
        suggestions.push("Add a dedicated 'Technical Skills' section to improve keyword parsing.");
    }

    // 3. Fix Content Quality
    if (metricsMatches.length < 3) {
        suggestions.push("Rewrite at least 3 bullet points to include specific numbers (e.g., 'Improved efficiency by 20%').");
    }
    if (verbCount < 2) {
        suggestions.push("Start your bullet points with strong action verbs (e.g., 'Orchestrated', 'Developed', 'Spearheaded').");
    }

    // 4. Fallback (Ensures the section is NEVER empty)
    if (suggestions.length === 0) {
        suggestions.push("Your resume structure is solid. Focus on tailoring the summary to the specific company values.");
        suggestions.push("Double-check for any minor typos or formatting inconsistencies.");
    }

    // Summary
    const summary = `ATS Score: ${atsScore}/100. ` +
        (atsScore >= 80 ? "Excellent match. Ready for submission." :
            atsScore >= 60 ? "Good potential, but missing specific keywords from the JD." :
                "Low match probability. Requires adding specific hard skills found in the JD.");

    return {
        summary,
        strengths,
        weaknesses,
        missingSkills,
        atsScore,
        suggestions,
        details: { matchedTechSkills, matchedSoftSkills } // Return for debugging UI
    };
}
/**
 * Predicts career path based on resume - IMPROVED for realistic predictions
 * @param {string} resumeText - The resume content
 * @param {string} jobDescription - The job description (for context)
 * @returns {Object} Career path predictions
 */
/**
 * AI Service for Resume Analysis
 */

import { GoogleGenerativeAI } from '@google/generative-ai';

/**
 * AI-Powered Career Path Prediction using Gemini API
 */
export async function predictCareerPathWithAI(resumeText, jobDescription) {
    const apiKey = process.env.GEMINI_API_KEY;

    if (!apiKey) {
        throw new Error('Gemini API key not configured');
    }

    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });

    const prompt = `You are an expert career counselor. Analyze this resume and predict career path.

RESUME:
${resumeText}

JOB DESCRIPTION:
${jobDescription}

Return ONLY valid JSON:
{
  "bestFitRoles": ["role1", "role2", "role3"],
  "futureRoles": ["role1", "role2"],
  "missingCertifications": ["cert1"],
  "skillsRoadmap": [{"skill": "skill", "priority": "High", "timeline": "2 months"}]
}`;

    try {
        const result = await model.generateContent(prompt);
        const text = result.response.text();

        let jsonText = text.trim();
        if (jsonText.startsWith('```json')) {
            jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
        }

        const careerPath = JSON.parse(jsonText);

        return {
            bestFitRoles: (careerPath.bestFitRoles || []).slice(0, 4),
            futureRoles: (careerPath.futureRoles || []).slice(0, 3),
            missingCertifications: (careerPath.missingCertifications || []).slice(0, 4),
            skillsRoadmap: (careerPath.skillsRoadmap || []).slice(0, 5)
        };
    } catch (error) {
        console.error('Gemini API Error:', error.message);
        throw error;
    }
}

/**
 * Calculates resume quality score (0-10)
 * @param {string} resumeText - The resume content
 * @param {string} jobDescription - The job description
 * @returns {Object} Quality score breakdown
 */
export function calculateQualityScore(resumeText, jobDescription) {
    const resumeLower = resumeText.toLowerCase();
    const jdLower = jobDescription.toLowerCase();

    // 1. Clarity (0-2 points)
    let clarityScore = 0;
    const sentences = resumeText.split(/[.!?]+/).filter(s => s.trim().length > 0);
    const avgSentenceLength = sentences.reduce((sum, s) => sum + s.split(' ').length, 0) / sentences.length;

    if (avgSentenceLength > 10 && avgSentenceLength < 25) clarityScore += 1; // Good sentence length
    if (resumeText.split('\n').filter(line => line.trim()).length > 10) clarityScore += 0.5; // Multiple sections
    if (resumeLower.includes('summary') || resumeLower.includes('objective')) clarityScore += 0.5; // Has summary
    clarityScore = Math.min(2, clarityScore);

    // 2. Structure (0-2 points)
    let structureScore = 0;
    const sections = ['experience', 'education', 'skills', 'projects'];
    const foundSections = sections.filter(section => resumeLower.includes(section));
    structureScore += Math.min(1.5, foundSections.length * 0.5);

    if (resumeText.length > 400 && resumeText.length < 2000) structureScore += 0.5; // Good length
    structureScore = Math.min(2, structureScore);

    // 3. Grammar (0-2 points) - Basic checks
    let grammarScore = 2; // Start with perfect, deduct for issues
    const commonErrors = [
        /\bi\s/g, // Lowercase 'i'
        /\s{2,}/g, // Multiple spaces
        /[a-z]\.[A-Z]/g, // Missing space after period
    ];

    commonErrors.forEach(pattern => {
        const matches = (resumeText.match(pattern) || []).length;
        grammarScore -= Math.min(0.5, matches * 0.1);
    });
    grammarScore = Math.max(0, grammarScore);

    // 4. ATS Compatibility (0-2 points)
    let atsScore = 0;
    const resumeWords = resumeLower.split(/\s+/);
    const jdWords = jdLower.split(/\s+/);
    const keywordOverlap = resumeWords.filter(word => word.length > 4 && jdWords.includes(word));

    if (keywordOverlap.length > 10) atsScore += 1;
    else if (keywordOverlap.length > 5) atsScore += 0.5;

    // No special characters in section headers
    if (!/[*#@$%]/.test(resumeText.substring(0, 200))) atsScore += 0.5;

    // Has contact info
    if (resumeLower.includes('email') || resumeLower.includes('@') || resumeLower.includes('phone')) atsScore += 0.5;
    atsScore = Math.min(2, atsScore);

    // 5. Relevancy (0-2 points)
    let relevancyScore = 0;
    const jdKeywords = jdWords.filter(w => w.length > 5);
    const matchedKeywords = jdKeywords.filter(kw => resumeLower.includes(kw));
    const relevancyRatio = matchedKeywords.length / Math.max(jdKeywords.length, 1);

    relevancyScore = Math.min(2, relevancyRatio * 4);

    // Calculate overall score
    const overall = clarityScore + structureScore + grammarScore + atsScore + relevancyScore;

    // Generate feedback
    const feedback = [];
    if (clarityScore < 1.5) feedback.push('Improve clarity by using concise, professional language');
    if (structureScore < 1.5) feedback.push('Add clear sections: Summary, Experience, Education, Skills');
    if (grammarScore < 1.5) feedback.push('Review for grammar and spelling errors');
    if (atsScore < 1.5) feedback.push('Include more keywords from the job description');
    if (relevancyScore < 1.5) feedback.push('Tailor resume more closely to the specific job requirements');

    if (overall >= 8) feedback.unshift('Excellent resume quality! Minor tweaks could make it perfect.');
    else if (overall >= 6) feedback.unshift('Good resume with room for improvement in key areas.');
    else feedback.unshift('Resume needs significant improvements to meet professional standards.');

    return {
        overall: Math.round(overall * 10) / 10,
        clarity: Math.round(clarityScore * 10) / 10,
        structure: Math.round(structureScore * 10) / 10,
        grammar: Math.round(grammarScore * 10) / 10,
        atsCompatibility: Math.round(atsScore * 10) / 10,
        relevancy: Math.round(relevancyScore * 10) / 10,
        feedback
    };
}

/**
 * Checks resume uniqueness and detects generic phrases
 * @param {string} resumeText - The resume content
 * @returns {Object} Uniqueness analysis
 */
export function checkUniqueness(resumeText) {
    const resumeLower = resumeText.toLowerCase();

    // Common clichés and generic phrases
    const cliches = [
        'hardworking', 'team player', 'think outside the box', 'go-getter',
        'detail-oriented', 'self-starter', 'motivated', 'passionate',
        'results-driven', 'dynamic', 'innovative', 'synergy',
        'leverage', 'best of breed', 'world-class', 'guru',
        'rockstar', 'ninja', 'unicorn', 'game-changer',
        'thought leader', 'strategic thinker', 'excellent communication skills',
        'proven track record', 'fast-paced environment', 'wear many hats', "passionate",
        "self-starter",
        "team player",
        "detail-oriented",
        "results-driven",
        "dynamic",
        "fast learner",
        "highly motivated",
        "proactive",
        "innovative",
        "hardworking",
        "excellent communication skills",
        "strong interpersonal skills",
        "creative thinker",
        "go-getter",
        "out-of-the-box thinker",
        "strategic thinker",
        "dedicated professional",

        // Meaningless Action Phrases
        "worked on",
        "handled",
        "responsible for",
        "in charge of",
        "helped with",
        "assisted in",
        "tasked with",
        "participated in",

        // Corporate Fluff
        "synergy",
        "cross-functional collaboration",
        "leveraged",
        "optimized processes",
        "mission-critical",
        "cutting-edge",
        "value-added",
        "best-in-class",
        "thought leadership",
        "industry-leading",
        "growth mindset",

        // Overused Achievements
        "improved efficiency",
        "increased productivity",
        "boosted performance",
        "streamlined workflow",
        "improved user experience",
        "reduced costs",
        "enhanced customer satisfaction",
        "delivered high-quality results",

        // Vague Impact Statements
        "made significant contributions",
        "played a key role",
        "made an impact",
        "contributed to project success",
        "added value",
        "improved multiple aspects",
        "supported growth",
        "positively influenced",

        // Generic Leadership Phrases
        "led a team",
        "provided leadership",
        "managed meetings",
        "mentored peers",
        "guided team members",
        "drove initiatives",
        "took ownership"
    ];

    const foundClichés = [];
    const genericPhrases = [];

    cliches.forEach(cliche => {
        if (resumeLower.includes(cliche)) {
            foundClichés.push(cliche);
            // Find the actual phrase in context
            const regex = new RegExp(`.{0,30}${cliche}.{0,30}`, 'i');
            const match = resumeText.match(regex);
            if (match && !genericPhrases.includes(match[0].trim())) {
                genericPhrases.push(match[0].trim());
            }
        }
    });

    // Calculate uniqueness score
    const totalWords = resumeText.split(/\s+/).length;
    const clicheWords = foundClichés.join(' ').split(/\s+/).length;

    // Base score
    let uniquenessScore = 100;

    // Deduct for clichés
    uniquenessScore -= foundClichés.length * 5;

    // Deduct for generic structure
    const genericStructure = [
        'responsible for',
        'duties included',
        'assisted with',
        'helped with',
        'worked on'
    ];

    genericStructure.forEach(phrase => {
        const count = (resumeLower.match(new RegExp(phrase, 'g')) || []).length;
        uniquenessScore -= count * 3;
    });

    // Bonus for specific achievements
    if (/\d+%/.test(resumeText)) uniquenessScore += 5; // Has percentages
    if (/\$\d+/.test(resumeText)) uniquenessScore += 5; // Has dollar amounts
    if (resumeLower.includes('increased') || resumeLower.includes('reduced')) uniquenessScore += 5;

    uniquenessScore = Math.max(0, Math.min(100, uniquenessScore));

    // Generate suggestions
    const suggestions = [];
    if (foundClichés.length > 0) {
        suggestions.push('Replace generic buz words with specific, quantifiable achievements');
    }
    if (genericStructure.some(phrase => resumeLower.includes(phrase))) {
        suggestions.push('Use action verbs like "Led", "Developed", "Implemented" instead of passive language');
    }
    if (!/\d+%/.test(resumeText)) {
        suggestions.push('Add quantifiable metrics (e.g., "Improved performance by 40%")');
    }
    if (foundClichés.length > 5) {
        suggestions.push('Focus on unique, specific contributions rather than common descriptors');
    }
    suggestions.push('Provide concrete examples of projects and their impact');

    return {
        score: Math.round(uniquenessScore),
        genericPhrases: genericPhrases.slice(0, 10),
        cliches: foundClichés.slice(0, 10),
        suggestions: suggestions.slice(0, 5)
    };
}
